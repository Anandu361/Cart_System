<!DOCTYPE html>
<html>
	<head>
		<title>Edit Product</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
	</head>
	<body>
		<h1 class="text-center m-2">Cart System <i class="bi bi-cart"></i></h1>
		<div th:replace="~{fragments/navbar :: navbar}"></div>
		<div class="container">
			<h2 class="text-center m-2">Edit Product</h2>

			<div class="d-flex justify-content-center">
				<form id="editForm" class="w-50 p-3 border rounded shadow-sm bg-light">
			  	<input type="hidden" id="id">
	
				<div class="mb-3">
	                <label class="form-label" for="name">Name:</label>
	                <input type="text" class="form-control form-control-sm" id="name" required>
	            </div>
				<div class="mb-3">
	                <label class="form-label">Price:</label>
	                <input type="number" class="form-control form-control-sm" id="price" required>
	            </div>
				<div class="mb-3">
	                <label class="form-label">Quantity:</label>
	                <input type="number" class="form-control form-control-sm" id="quantity" required>
	            </div>
	
				<div class="m-2 mx-auto d-flex justify-content-center">
					<button type="submit" class="btn btn-primary">Update</button>
				</div>
			</form>
			</div>
		</div>
		<div th:replace="~{fragments/footer :: footer}"></div>

		<script>
		const params = new URLSearchParams(window.location.search);
		const id = params.get("id");
		const token = localStorage.getItem("token");

		if (!token) {
		  alert("Not logged in");
		  window.location.href = "/login";
		}

		// ✅ Load product
		fetch(`/api/test/products/${id}`, {
		  headers: { "Authorization": "Bearer " + token }
		})
		.then(res => {
		  if (!res.ok) throw new Error("Fetch failed");
		  return res.json();
		})
		.then(p => {
		  document.getElementById("id").value = p.id;
		  document.getElementById("name").value = p.name;
		  document.getElementById("price").value = p.price;
		  document.getElementById("quantity").value = p.quantity;
		});

		// ✅ Update product (FIXED)
		document.getElementById("editForm").addEventListener("submit", e => {
		  e.preventDefault();

		  const nameVal = document.getElementById("name").value;
		  const priceVal = document.getElementById("price").value;
		  const quantityVal = document.getElementById("quantity").value;

		  fetch(`/api/test/products/update/${id}`, {
		    method: "PUT",
		    headers: {
		      "Content-Type": "application/json",
		      "Authorization": "Bearer " + token
		    },
		    body: JSON.stringify({
		      name: nameVal,
		      price: priceVal,
		      quantity: quantityVal
		    })
		  })
		  .then(res => {
		    if (!res.ok) throw new Error("Update failed");
		    return res.json();
		  })
		  .then(() => {
		    alert("Product updated");
		    window.location.href = "/products";
		  })
		  .catch(() => {
		    alert("Session expired or update failed");
		    localStorage.removeItem("token");
		    window.location.href = "/login";
		  });
		});
		</script>


	</body>
</html>